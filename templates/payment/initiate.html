{% extends 'layout.html' %}

{% block title %}Payment - MotorParts Pro{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body text-center p-5">
                    <i class="fas fa-credit-card fa-4x text-primary mb-4"></i>
                    <h2 class="mb-4">Complete Payment</h2>
                    <p class="text-muted mb-2">Order: <strong>{{ order.order_number }}</strong></p>
                    <h3 class="mb-4">â‚¦<span id="order-amount">{{ order.total_amount }}</span></h3>
                    
                    <button id="payButton" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-lock me-2"></i>Pay with Paystack
                    </button>
                    
                    <p class="text-muted mt-3 small">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure payment powered by Paystack
                    </p>
                    
                    <a href="{% url 'orders:detail' order.id %}" class="btn btn-link mt-2">
                        Cancel and return to order
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    // Format price with commas
    document.addEventListener('DOMContentLoaded', function() {
        const amountElement = document.getElementById('order-amount');
        const amount = parseFloat(amountElement.textContent);
        amountElement.textContent = amount.toLocaleString('en-NG', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    });
    
    const payButton = document.getElementById('payButton');
    
    payButton.addEventListener('click', function() {
        const handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}',
            email: '{{ email }}',
            amount: {{ amount_in_kobo }},
            currency: 'NGN',
            ref: '{{ reference }}',
            callback: function(response){
                window.location.href = "{{ callback_url }}";
            },
            onClose: function() {
                console.log('[v0] Payment window closed');
                alert('Payment window closed. You can try again when ready.');
            }
        });
        
        handler.openIframe();
    });
</script>
{% endblock %}
