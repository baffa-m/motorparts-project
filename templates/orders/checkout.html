{% extends 'layout.html' %}

{% block title %}Checkout - MotorParts Pro{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="fw-bold text-primary mb-4">Checkout</h2>

    <form method="post">
        {% csrf_token %}
        <div class="row">
             Shipping Info 
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shipping-fast me-2"></i>Shipping Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if user_profile and user_profile.address %}
                        <div class="alert alert-info d-flex align-items-center mb-4">
                            <div class="form-check flex-grow-1">
                                <input class="form-check-input" type="checkbox" id="use_profile_address" 
                                       name="use_profile_address" onchange="toggleProfileAddress()">
                                <label class="form-check-label" for="use_profile_address">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <strong>Use my saved address</strong>
                                    <div class="small mt-1">
                                        {{ user_profile.address }}, {{ user_profile.city }}, {{ user_profile.state }}
                                        {% if user_profile.postal_code %}{{ user_profile.postal_code }}{% endif %}
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" name="first_name" id="first_name"
                                       value="{{ user.first_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" name="last_name" id="last_name"
                                       value="{{ user.last_name }}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" name="phone" id="phone"
                                   value="{{ user.phone_no }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address *</label>
                            <input type="text" class="form-control" name="address" id="address"
                                   placeholder="House number and street name" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">City *</label>
                                <input type="text" class="form-control" name="city" id="city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">State *</label>
                                <select class="form-select" name="state" id="state" required>
                                    <option value="">Select State</option>
                                    <option value="Abia">Abia</option>
                                    <option value="Adamawa">Adamawa</option>
                                    <option value="Akwa Ibom">Akwa Ibom</option>
                                    <option value="Anambra">Anambra</option>
                                    <option value="Bauchi">Bauchi</option>
                                    <option value="Bayelsa">Bayelsa</option>
                                    <option value="Benue">Benue</option>
                                    <option value="Borno">Borno</option>
                                    <option value="Cross River">Cross River</option>
                                    <option value="Delta">Delta</option>
                                    <option value="Ebonyi">Ebonyi</option>
                                    <option value="Edo">Edo</option>
                                    <option value="Ekiti">Ekiti</option>
                                    <option value="Enugu">Enugu</option>
                                    <option value="FCT">Federal Capital Territory</option>
                                    <option value="Gombe">Gombe</option>
                                    <option value="Imo">Imo</option>
                                    <option value="Jigawa">Jigawa</option>
                                    <option value="Kaduna">Kaduna</option>
                                    <option value="Kano">Kano</option>
                                    <option value="Katsina">Katsina</option>
                                    <option value="Kebbi">Kebbi</option>
                                    <option value="Kogi">Kogi</option>
                                    <option value="Kwara">Kwara</option>
                                    <option value="Lagos">Lagos</option>
                                    <option value="Nasarawa">Nasarawa</option>
                                    <option value="Niger">Niger</option>
                                    <option value="Ogun">Ogun</option>
                                    <option value="Ondo">Ondo</option>
                                    <option value="Osun">Osun</option>
                                    <option value="Oyo">Oyo</option>
                                    <option value="Plateau">Plateau</option>
                                    <option value="Rivers">Rivers</option>
                                    <option value="Sokoto">Sokoto</option>
                                    <option value="Taraba">Taraba</option>
                                    <option value="Yobe">Yobe</option>
                                    <option value="Zamfara">Zamfara</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Postal Code (Optional)</label>
                            <input type="text" class="form-control" name="postal_code" id="postal_code">
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-truck me-2"></i>Shipping Method
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="shipping-methods">
                            {% for method in shipping_methods %}
                            <div class="form-check shipping-method-card">
                                <input class="form-check-input" type="radio" name="shipping_method" 
                                       value="{{ method.id }}" id="shipping_{{ method.id }}" 
                                       data-cost="{{ method.base_cost }}"
                                       onchange="updateShippingCost()"
                                       {% if forloop.first %}checked{% endif %}>
                                <label class="form-check-label w-100" for="shipping_{{ method.id }}">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <strong>{{ method.name }}</strong>
                                            <p class="small text-muted mb-0">{{ method.description }}</p>
                                            <p class="small text-muted mb-0">
                                                <i class="fas fa-clock me-1"></i>{{ method.get_duration_display }}
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <strong class="text-primary">₦{{ method.base_cost|floatformat:2 }}</strong>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% empty %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Standard shipping will be applied at checkout.
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                 Payment Method 
                <div class="card mt-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>Payment Method
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="form-check payment-method-card">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       value="paystack" id="paystack" checked>
                                <label class="form-check-label w-100" for="paystack">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
                                            <strong>Card Payment (Paystack)</strong>
                                            <p class="small text-muted mb-0">Pay securely with your debit/credit card</p>
                                        </div>
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                </label>
                            </div>

                            <div class="form-check payment-method-card">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       value="bank_transfer" id="bank_transfer">
                                <label class="form-check-label w-100" for="bank_transfer">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="fas fa-university fa-2x text-primary me-3"></i>
                                            <strong>Bank Transfer</strong>
                                            <p class="small text-muted mb-0">Transfer directly to our bank account</p>
                                        </div>
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                </label>
                            </div>

                            <div class="form-check payment-method-card">
                                <input class="form-check-input" type="radio" name="payment_method" 
                                       value="cash_on_delivery" id="cash_on_delivery">
                                <label class="form-check-label w-100" for="cash_on_delivery">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="fas fa-money-bill-wave fa-2x text-primary me-3"></i>
                                            <strong>Cash on Delivery</strong>
                                            <p class="small text-muted mb-0">Pay when you receive your order</p>
                                        </div>
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             Order Summary 
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 100px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                         Items 
                        <div class="order-items-summary mb-3">
                            {% for item in cart_items %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small">{{ item.part.name }} x{{ item.quantity }}</span>
                                <span class="small">₦{{ item.get_total_price|floatformat:2 }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong>₦{{ subtotal|floatformat:2 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <strong id="shipping-cost">₦{{ shipping_amount|floatformat:2 }}</strong>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-4">
                            <h5>Total:</h5>
                            <h5 class="text-primary" id="total-amount">₦{{ total_amount|floatformat:2 }}</h5>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-lock me-2"></i>Place Order
                        </button>

                         Trust Badges 
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-shield-alt text-success me-2"></i>
                                <small>Secure SSL Encryption</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-lock text-success me-2"></i>
                                <small>Your data is protected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.payment-method-card, .shipping-method-card {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method-card:hover, .shipping-method-card:hover {
    border-color: var(--accent-color);
    background: rgba(139, 92, 246, 0.05);
}

.payment-method-card input[type="radio"], .shipping-method-card input[type="radio"] {
    display: none;
}

.payment-method-card input[type="radio"]:checked ~ label, .shipping-method-card input[type="radio"]:checked ~ label {
    font-weight: 600;
}

.payment-method-card input[type="radio"]:checked ~ label .fa-check-circle, .shipping-method-card input[type="radio"]:checked ~ label .fa-check-circle {
    display: inline-block;
}

.payment-method-card label .fa-check-circle, .shipping-method-card label .fa-check-circle {
    display: none;
}

.payment-method-card:has(input[type="radio"]:checked), .shipping-method-card:has(input[type="radio"]:checked) {
    border-color: var(--accent-color);
    background: rgba(139, 92, 246, 0.05);
}

.order-items-summary {
    max-height: 200px;
    overflow-y: auto;
}
</style>

<script>
function toggleProfileAddress() {
    const checkbox = document.getElementById('use_profile_address');
    const isChecked = checkbox.checked;
    
    if (isChecked) {
        // Auto-fill with profile address
        {% if user_profile %}
        document.getElementById('address').value = '{{ user_profile.address|escapejs }}';
        document.getElementById('city').value = '{{ user_profile.city|escapejs }}';
        document.getElementById('state').value = '{{ user_profile.state|escapejs }}';
        document.getElementById('postal_code').value = '{{ user_profile.postal_code|escapejs }}';
        
        // Disable fields to indicate they're from profile
        document.getElementById('address').readOnly = true;
        document.getElementById('city').readOnly = true;
        document.getElementById('state').disabled = true;
        document.getElementById('postal_code').readOnly = true;
        
        // Add visual indicator
        document.getElementById('address').classList.add('bg-light');
        document.getElementById('city').classList.add('bg-light');
        document.getElementById('state').classList.add('bg-light');
        document.getElementById('postal_code').classList.add('bg-light');
        {% endif %}
    } else {
        // Clear and enable fields
        document.getElementById('address').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('postal_code').value = '';
        
        document.getElementById('address').readOnly = false;
        document.getElementById('city').readOnly = false;
        document.getElementById('state').disabled = false;
        document.getElementById('postal_code').readOnly = false;
        
        document.getElementById('address').classList.remove('bg-light');
        document.getElementById('city').classList.remove('bg-light');
        document.getElementById('state').classList.remove('bg-light');
        document.getElementById('postal_code').classList.remove('bg-light');
    }
}

function updateShippingCost() {
    const selectedShipping = document.querySelector('input[name="shipping_method"]:checked');
    if (!selectedShipping) return;
    
    const shippingCost = parseFloat(selectedShipping.dataset.cost);
    const subtotal = {{ subtotal }};
    const total = subtotal + shippingCost;
    
    document.getElementById('shipping-cost').textContent = '₦' + formatPrice(shippingCost);
    document.getElementById('total-amount').textContent = '₦' + formatPrice(total);
}
</script>
{% endblock %}
